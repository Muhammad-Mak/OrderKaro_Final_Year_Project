<h2>Dashboard Analytics</h2>

<!-- TOP CARDS -->
<section class="stats-row">
  <div class="card metric-card">
    <h3>Total Users</h3>
    <p>{{ totalUsers }}</p>
  </div>
  <div class="card metric-card">
    <h3>Total Orders</h3>
    <p>{{ totalOrders }}</p>
  </div>
  <div class="card metric-card">
    <h3>Total Revenue</h3>
    <p>{{ totalRevenue | currency:'PKR' }}</p>
  </div>
</section>

<!-- ORDERS THIS WEEK GRAPH -->
<section class="graph-section">
  <div class="card graph-card">
    <h3>Orders This Week</h3>
    <canvas baseChart [data]="ordersWeekData" [options]="lineChartOptions" [type]="'line'">
    </canvas>
  </div>
</section>

<!-- BAR & PIE SIDE BY SIDE -->
<section class="side-by-side-charts">
  <div class="card side-chart">
    <h3>Top 6 Ordered Items</h3>
    <canvas baseChart [data]="topItemsData" [options]="barChartOptions" [type]="'bar'">
    </canvas>
  </div>
  <div class="card side-chart">
    <h3>Pickup vs Delivery</h3>
    <canvas baseChart [data]="orderTypeData" [options]="pieChartOptions" [type]="'pie'">
    </canvas>
  </div>
</section>

<!-- ðŸ”¥ FORECAST SECTION -->
<section class="graph-section mt-4">
  <div class="card graph-card">
    <h3>Forecast Sales (Next 7 Days)</h3>

    <div class="d-flex align-items-center gap-2 mb-3">
      <label for="menuItemSelect" class="form-label m-0">Select Item:</label>
      <select id="menuItemSelect" class="form-select w-auto" [(ngModel)]="selectedItemId">
        <option [value]="null" disabled selected>Select menu item</option>
        <option *ngFor="let item of menuItems" [value]="item.menuItemId">
          {{ item.name }}
        </option>
      </select>
      <button class="btn btn-primary" (click)="loadForecast()" [disabled]="!selectedItemId">
        Get Forecast
      </button>
    </div>

    <div *ngIf="forecastVisible">
      <canvas baseChart [data]="forecastData" [options]="lineChartOptions" [type]="'line'">
      </canvas>
    </div>
  </div>
</section>

<!-- USERS TABLE -->
<section class="users">
  <h3>Users</h3>
  <div class="table-search">
    <input type="text" [(ngModel)]="searchUserQuery" placeholder="Search users by name, email, or role..." />
  </div>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>University ID</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let user of filteredUsers()">
        <td>
          <div *ngIf="editUser?.userId !== user.userId">{{ user.firstName }} {{ user.lastName }}</div>
          <div *ngIf="editUser?.userId === user.userId">
            <input [(ngModel)]="editUser.firstName" placeholder="First" />
            <input [(ngModel)]="editUser.lastName" placeholder="Last" />
          </div>
        </td>
        <td>{{ user.email }}</td>
        <td>
          <div *ngIf="editUser?.userId !== user.userId">{{ user.role }}</div>
          <div *ngIf="editUser?.userId === user.userId">
            <select [(ngModel)]="editUser.role">
              <option value="Customer">Customer</option>
              <option value="Admin">Admin</option>
              <option value="Staff">Staff</option>
            </select>
          </div>
        </td>
        <td>
          <div *ngIf="editUser?.userId !== user.userId">{{ user.studentId || 'N/A' }}</div>
          <div *ngIf="editUser?.userId === user.userId">
            <input [(ngModel)]="editUser.studentId" placeholder="University ID" />
          </div>
        </td>

        <td>
          <div *ngIf="editUser?.userId !== user.userId">
            <button class="view" (click)="selectUser(user)">View Orders</button>
            <button class="edit" (click)="edit(user)">Edit</button>
            <button class="delete" (click)="confirmDelete(user)">Delete</button>
          </div>
          <div *ngIf="editUser?.userId === user.userId">
            <button class="view" (click)="saveEdit()">Save</button>
            <button class="cancel" (click)="cancelEdit()">Cancel</button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</section>

<!-- USER ORDERS -->
<section *ngIf="selectedUser">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h4>Orders by {{ selectedUser.firstName }}</h4>
    <button (click)="selectedUser = null" style="font-weight: bold; border: none; background: transparent; cursor: pointer; color: #f44336;">âœ•</button>
  </div>
  <table>
    <thead>
      <tr><th>Order #</th><th>Status</th><th>Total</th></tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let order of userOrders">
        <tr (click)="toggleOrderExpand(order.orderId)" style="cursor: pointer;">
          <td>{{ order.orderNumber }}</td>
          <td>{{ order.status }}</td>
          <td>{{ order.totalAmount | currency:'PKR' }}</td>
        </tr>
        <tr *ngIf="expandedOrders.has(order.orderId)">
          <td colspan="3" class="order-details-cell">
            <p><strong>Placed At:</strong> {{ order.orderDate | date:'dd MMM, yyyy hh:mm a' }}</p>
            <p><strong>Order Type:</strong> {{ order.orderType }}
              <span *ngIf="order.orderType === 'Delivery'">
                &nbsp;|&nbsp; <strong>Delivery Location:</strong> {{ order.deliveryLocation || 'N/A' }}
              </span>
            </p>
            <p><strong>Order Items:</strong></p>
            <ul>
              <li *ngFor="let item of order.orderItems">
                {{ item.menuItemName }} Ã— {{ item.quantity }}
                <span *ngIf="item.specialInstructions"> â€” {{ item.specialInstructions }}</span>
              </li>
            </ul>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</section>


<!-- ALL ORDERS -->
<section class="all-orders">
  <h3>All Orders</h3>
  <div class="table-search">
    <input
      type="text"
      [(ngModel)]="searchOrderQuery"
      placeholder="Search orders by order #, name or status..."
    />
  </div>
  <table>
    <thead>
      <tr><th>Order #</th><th>User</th><th>Status</th><th>Total</th></tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let order of filteredOrders()">
        <tr (click)="toggleOrderExpand(order.orderId)" style="cursor: pointer;">
          <td>{{ order.orderNumber }}</td>
          <td>{{ order.firstName ?? 'N/A' }} {{ order.lastName ?? '' }}</td>
          <td>{{ order.status }}</td>
          <td>{{ order.totalAmount | currency:'PKR' }}</td>
        </tr>
        <tr *ngIf="expandedOrders.has(order.orderId)">
          <td colspan="4" class="order-details-cell">
            <p><strong>Placed At:</strong> {{ order.orderDate | date:'dd MMM, yyyy hh:mm a' }}</p>
            <p><strong>Order Type:</strong> {{ order.orderType }}
              <span *ngIf="order.orderType === 'Delivery'">
                &nbsp;|&nbsp; <strong>Delivery Location:</strong> {{ order.deliveryLocation || 'N/A' }}
              </span>
            </p>
            <p><strong>Order Items:</strong></p>
            <ul>
              <li *ngFor="let item of order.orderItems">
                {{ item.menuItemName }} Ã— {{ item.quantity }}
                <span *ngIf="item.specialInstructions"> â€” {{ item.specialInstructions }}</span>
              </li>
            </ul>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</section>
