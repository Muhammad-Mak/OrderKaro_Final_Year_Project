<!-- active-orders.component.html -->
<!-- This template displays a searchable, interactive table of all active orders.
     Users can expand rows to view order details, toggle "prepared" checkboxes,
     and mark orders as "completed." -->

<section class="active-orders">
  <h3>Active Orders</h3>

  <!-- Search bar for filtering orders by order number, user name, or status -->
  <div class="table-search">
    <input 
      type="text" 
      [(ngModel)]="searchOrderQuery" 
      placeholder="Search by order #, user or status..." 
    />
  </div>

  <table>
    <thead>
      <tr>
        <th>Order #</th>
        <th>User</th>
        <th>Status</th>
        <th>Prepared</th>
        <th>Completed</th>
      </tr>
    </thead>
    <tbody>
      <!-- Iterate over filtered orders -->
      <ng-container *ngFor="let order of filteredOrders(); let i = index">
        <!-- Main row showing basic order info -->
        <tr 
          (click)="toggleExpand(order.orderId)" 
          style="cursor: pointer;"
        >
          <td>{{ order.orderNumber }}</td>
          <td>{{ order.firstName ?? 'N/A' }} {{ order.lastName ?? '' }}</td>
          <td>{{ order.status }}</td>
          <td>
            <!-- Checkbox for "Prepared" status (local UI toggle only) -->
             <!--  stop propagation Prevents triggering expand -->
            <input 
              type="checkbox" 
              [checked]="order.status === 'Prepared' "
              (click)="$event.stopPropagation()"  
              (change)="markPrepared(order)" 
            />
          </td>
          <td>
            <!-- Checkbox for marking as "Completed" -->
            <input 
              type="checkbox" 
              [checked]="order.status === 'Completed'" 
              [disabled]="order.status === 'Completed'" 
              (click)="$event.stopPropagation()" 
              (change)="markCompleted(order)" 
            />
          </td>
        </tr>

        <!-- Expanded details row for a selected order -->
        <tr *ngIf="expandedOrderIds.has(order.orderId)">
          <td colspan="5" class="order-details-cell">
            <p><strong>Placed At:</strong> {{ order.orderDate | date:'dd MMM, yyyy h:mm a' }}</p>

            <!-- Show scheduled time only if different from original order date -->
            <p *ngIf="order.scheduledTime && (order.scheduledTime !== order.orderDate)">
              <strong>Scheduled For:</strong> 
              {{ order.scheduledTime | date:'dd MMM, yyyy h:mm a':'Asia/Karachi' }}
            </p>

            <p>
              <strong>Order Type:</strong> {{ order.orderType }}
              <!-- Show delivery location if applicable -->
              <span *ngIf="order.orderType === 'Delivery'">
                &nbsp;|&nbsp; <strong>Delivery Location:</strong> 
                {{ order.deliveryLocation || 'N/A' }}
              </span>
            </p>

            <p><strong>Order Items:</strong></p>
            <ul class="order-items-list">
              <!-- Display ordered items and optional instructions -->
              <li *ngFor="let item of order.orderItems">
                {{ item.menuItemName }} × {{ item.quantity }}
                <span *ngIf="item.specialInstructions"> — {{ item.specialInstructions }}</span>
              </li>
            </ul>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</section>
